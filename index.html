<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EE Board Exam Study Helper</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Your existing CSS remains unchanged */
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Your existing CSS remains the same, just adding a few additions */
        .text-secondary {
            color: var(--text-secondary);
        }

        .error-message {
            color: var(--danger-color);
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        /* Add any missing styles from your original file here */
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <i class="fas fa-microchip loading-icon"></i>
            <h2>Electronics Engineering</h2>
            <p>Board Exam Study Helper</p>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Main Container -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-content">
                <div class="nav-brand">
                    <i class="fas fa-microchip"></i>
                    <span>EE Study Helper</span>
                </div>
                <div class="nav-actions">
                    <a href="admin.html" class="nav-btn">
                        <i class="fas fa-cog"></i>
                        Admin
                    </a>
                    <button id="statsBtn" class="nav-btn">
                        <i class="fas fa-chart-bar"></i>
                        Stats
                    </button>
                </div>
            </div>
        </nav>

        <!-- Study Mode Selection -->
        <div id="modeSelection" class="mode-selection">
            <div class="container">
                <h1 class="main-title">Choose Your Study Mode</h1>
                <div class="mode-grid">
                    <div class="mode-card" data-mode="practice">
                        <i class="fas fa-brain"></i>
                        <h3>Practice Mode</h3>
                        <p>Study at your own pace with no time limits</p>
                    </div>
                    <div class="mode-card" data-mode="timed">
                        <i class="fas fa-clock"></i>
                        <h3>Timed Mode</h3>
                        <p>Challenge yourself with time constraints</p>
                    </div>
                    <div class="mode-card" data-mode="board-exam">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>Board Exam Mode</h3>
                        <p>Simulate actual board exam conditions</p>
                    </div>
                    <div class="mode-card" data-mode="review">
                        <i class="fas fa-redo"></i>
                        <h3>Review Mode</h3>
                        <p>Review previously missed questions</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Configuration Modal -->
        <div id="configModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-cog"></i> Quiz Configuration</h3>
                    <button id="closeConfigBtn" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="config-content">
                    <div class="disable-examples-checkbox">
                        <input type="checkbox" id="disableExamples">
                        <label for="disableExamples">Disable example questions (use only uploaded questions)</label>
                    </div>
                    
                    <div class="config-option">
                        <label>Subject Area:</label>
                        <select id="subjectSelect">
                            <option value="all">All Subjects</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="electronics-engineering">Electronics Engineering</option>
                            <option value="general-engineering">General Engineering & Applied Sciences</option>
                            <option value="electronics-systems">Electronics Systems & Technologies</option>
                        </select>
                    </div>
                    
                    <div class="config-option">
                        <label>Number of Questions:</label>
                        <div class="question-limit-buttons">
                            <button class="limit-btn active" data-limit="10">10</button>
                            <button class="limit-btn" data-limit="30">30</button>
                            <button class="limit-btn" data-limit="50">50</button>
                            <button class="limit-btn" data-limit="100">100</button>
                            <button class="limit-btn" data-limit="all">All</button>
                        </div>
                    </div>

                    <div class="config-option">
                        <label>Difficulty Level:</label>
                        <select id="difficultySelect">
                            <option value="all">All Levels</option>
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>

                    <div id="availableCount" style="margin-bottom: 1rem; color: var(--text-secondary);">
                        Available questions: 0
                    </div>

                    <button id="startQuizBtn" class="start-quiz-btn">
                        <i class="fas fa-play"></i>
                        Start Quiz
                    </button>
                </div>
            </div>
        </div>

        <!-- Study Interface -->
        <div id="studyInterface" class="study-interface" style="display: none;">
            <!-- Study Header -->
            <div class="study-header">
                <div class="study-controls">
                    <button id="backBtn" class="control-btn">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                    <div class="progress-info">
                        <span id="questionCounter">1 of 10</span>
                    </div>
                    <div class="timer-section" id="timerSection" style="display: none;">
                        <i class="fas fa-clock"></i>
                        <span id="timer">00:30</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>

            <!-- Question Card -->
            <div id="questionCard" class="question-card">
                <div class="question-header">
                    <span id="questionNumber" class="question-number">#1</span>
                    <div class="difficulty-indicator">
                        <i class="fas fa-star"></i>
                        <span id="questionDifficulty">Medium</span>
                    </div>
                </div>
                
                <div class="question-content">
                    <div id="questionText" class="question-text">
                        Loading question...
                    </div>
                    
                    <div id="optionsContainer" class="options-grid">
                        <!-- Options will be populated here -->
                    </div>
                </div>

                <div id="explanationSection" class="explanation-section" style="display: none;">
                    <h4>Explanation:</h4>
                    <p id="explanationText">No explanation available for this question.</p>
                </div>

                <div class="answer-actions">
                    <button id="submitBtn" class="primary-btn" disabled>
                        <i class="fas fa-check"></i>
                        Submit Answer
                    </button>
                    <button id="nextBtn" class="primary-btn" style="display: none;">
                        Next Question
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <button id="hintBtn" class="secondary-btn">
                        <i class="fas fa-lightbulb"></i>
                        Hint
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Modal -->
        <div id="resultsModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-trophy"></i> Quiz Results</h3>
                    <button id="closeResultsBtn" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="results-content">
                    <div id="scoreDisplay" class="score-display">0%</div>
                    <div class="results-stats">
                        <div class="stat-item">
                            <div id="correctCount" class="stat-value">0</div>
                            <div class="stat-label">Correct</div>
                        </div>
                        <div class="stat-item">
                            <div id="incorrectCount" class="stat-value">0</div>
                            <div class="stat-label">Incorrect</div>
                        </div>
                        <div class="stat-item">
                            <div id="timeTaken" class="stat-value">0m</div>
                            <div class="stat-label">Time Taken</div>
                        </div>
                        <div class="stat-item">
                            <div id="accuracyRate" class="stat-value">0%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button id="retakeBtn" class="primary-btn">
                            <i class="fas fa-redo"></i>
                            Retake Quiz
                        </button>
                        <button id="reviewIncorrectBtn" class="secondary-btn">
                            <i class="fas fa-eye"></i>
                            Review Incorrect
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hint Modal -->
        <div id="hintModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-lightbulb"></i> Hint</h3>
                    <button id="closeHintBtn" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="padding: 2rem;">
                    <p id="hintText">No hint available for this question.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Service Layer
        class QuestionAPIService {
            static STORAGE_KEYS = {
                QUESTIONS: 'eeQuestions',
                STATS: 'eeStudyStats',
                ADMIN_PASSWORD: 'adminPassword'
            };

            // Get all questions
            static getQuestions() {
                try {
                    const questions = localStorage.getItem(this.STORAGE_KEYS.QUESTIONS);
                    return questions ? JSON.parse(questions) : [];
                } catch (error) {
                    console.error('Error retrieving questions:', error);
                    return [];
                }
            }

            // Save questions to storage
            static saveQuestions(questions) {
                try {
                    localStorage.setItem(this.STORAGE_KEYS.QUESTIONS, JSON.stringify(questions));
                    return true;
                } catch (error) {
                    console.error('Error saving questions:', error);
                    return false;
                }
            }

            // Add a new question
            static addQuestion(questionData) {
                const questions = this.getQuestions();
                const newQuestion = {
                    id: Date.now(), // Simple ID generation
                    ...questionData,
                    createdAt: new Date().toISOString()
                };
                
                questions.push(newQuestion);
                const success = this.saveQuestions(questions);
                
                return success ? newQuestion : null;
            }

            // Update an existing question
            static updateQuestion(id, questionData) {
                const questions = this.getQuestions();
                const index = questions.findIndex(q => q.id === id);
                
                if (index === -1) return false;
                
                questions[index] = {
                    ...questions[index],
                    ...questionData,
                    updatedAt: new Date().toISOString()
                };
                
                return this.saveQuestions(questions);
            }

            // Delete a question
            static deleteQuestion(id) {
                const questions = this.getQuestions();
                const filteredQuestions = questions.filter(q => q.id !== id);
                return this.saveQuestions(filteredQuestions);
            }

            // Get stats
            static getStats() {
                try {
                    const stats = localStorage.getItem(this.STORAGE_KEYS.STATS);
                    return stats ? JSON.parse(stats) : {};
                } catch (error) {
                    console.error('Error retrieving stats:', error);
                    return {};
                }
            }

            // Update stats
            static updateStats(stats) {
                try {
                    localStorage.setItem(this.STORAGE_KEYS.STATS, JSON.stringify(stats));
                    return true;
                } catch (error) {
                    console.error('Error saving stats:', error);
                    return false;
                }
            }

            // Get admin password
            static getAdminPassword() {
                try {
                    return localStorage.getItem(this.STORAGE_KEYS.ADMIN_PASSWORD) || 'admin123';
                } catch (error) {
                    console.error('Error retrieving admin password:', error);
                    return 'admin123';
                }
            }

            // Set admin password
            static setAdminPassword(password) {
                try {
                    localStorage.setItem(this.STORAGE_KEYS.ADMIN_PASSWORD, password);
                    return true;
                } catch (error) {
                    console.error('Error setting admin password:', error);
                    return false;
                }
            }
        }

        // Enhanced Study App with API integration
        class StudyApp {
            constructor() {
                this.defaultQuestions = [
                    {
                        id: 1,
                        subject: 'electronics-engineering',
                        category: 'semiconductor-devices',
                        difficulty: 'Medium',
                        question: 'What is the typical forward voltage drop of a silicon diode at room temperature?',
                        options: {
                            A: '0.3V',
                            B: '0.7V',
                            C: '1.4V',
                            D: '2.1V'
                        },
                        correctAnswer: 'B',
                        explanation: 'Silicon diodes have a forward voltage drop of approximately 0.7V at room temperature (25°C), while germanium diodes have about 0.3V.',
                        hint: 'Think about the most common semiconductor material used in modern diodes.'
                    },
                    {
                        id: 2,
                        subject: 'mathematics',
                        category: 'circuit-analysis',
                        difficulty: 'Easy',
                        question: 'What is the equivalent resistance of two 100Ω resistors connected in parallel?',
                        options: {
                            A: '200Ω',
                            B: '100Ω',
                            C: '50Ω',
                            D: '25Ω'
                        },
                        correctAnswer: 'C',
                        explanation: 'For parallel resistors: 1/Req = 1/R1 + 1/R2 = 1/100 + 1/100 = 2/100, therefore Req = 50Ω',
                        hint: 'Remember the parallel resistance formula: 1/Req = 1/R1 + 1/R2'
                    },
                    {
                        id: 3,
                        subject: 'electronics-systems',
                        category: 'digital-systems',
                        difficulty: 'Easy',
                        question: 'How many bits are in a byte?',
                        options: {
                            A: '4 bits',
                            B: '6 bits',
                            C: '8 bits',
                            D: '16 bits'
                        },
                        correctAnswer: 'C',
                        explanation: 'A byte consists of 8 bits. This is a fundamental unit in digital systems and computer architecture.',
                        hint: 'This is a basic unit of digital information storage.'
                    },
                    {
                        id: 4,
                        subject: 'general-engineering',
                        category: 'physics',
                        difficulty: 'Medium',
                        question: 'What is the unit of electrical power?',
                        options: {
                            A: 'Volt (V)',
                            B: 'Ampere (A)',
                            C: 'Watt (W)',
                            D: 'Ohm (Ω)'
                        },
                        correctAnswer: 'C',
                        explanation: 'The watt (W) is the SI unit of power, including electrical power. It represents energy transfer per unit time.',
                        hint: 'Think about what unit is used for light bulbs and electrical appliances.'
                    },
                    {
                        id: 5,
                        subject: 'electronics-engineering',
                        category: 'amplifiers',
                        difficulty: 'Hard',
                        question: 'In an operational amplifier, what is the typical input impedance?',
                        options: {
                            A: '1 kΩ',
                            B: '10 kΩ',
                            C: '1 MΩ',
                            D: '10 MΩ or higher'
                        },
                        correctAnswer: 'D',
                        explanation: 'Operational amplifiers typically have very high input impedance (10 MΩ or higher) to minimize loading effects on the input signal source.',
                        hint: 'Op-amps are designed to have minimal effect on the circuits they are connected to.'
                    }
                ];
                
                this.uploadedQuestions = [];
                this.currentMode = null;
                this.currentQuestionIndex = 0;
                this.selectedQuestions = [];
                this.studySession = {
                    correct: 0,
                    incorrect: 0,
                    startTime: null,
                    answers: [],
                    config: {}
                };
                this.selectedAnswer = null;
                this.isAnswered = false;
                this.timer = null;
                this.timeLeft = 30;
                this.questionTimeLimit = 30; // seconds per question
                
                this.init();
            }

            get questions() {
                const disableExamples = document.getElementById('disableExamples')?.checked || false;
                if (disableExamples) {
                    return this.uploadedQuestions.length > 0 ? this.uploadedQuestions : [];
                }
                return [...this.defaultQuestions, ...this.uploadedQuestions];
            }
            
            init() {
                this.showLoading();
                setTimeout(() => {
                    this.hideLoading();
                    this.setupEventListeners();
                    this.loadSavedData();
                }, 2000);
            }
            
            showLoading() {
                document.getElementById('loadingScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
            
            hideLoading() {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
            }
            
            setupEventListeners() {
                // Mode selection
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.addEventListener('click', () => {
                        this.selectMode(card.dataset.mode);
                    });
                });
                
                // Configuration modal
                document.getElementById('closeConfigBtn').addEventListener('click', () => {
                    this.hideConfigModal();
                });

                document.getElementById('disableExamples').addEventListener('change', () => {
                    this.updateAvailableCount();
                });
                
                document.querySelectorAll('.limit-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.selectQuestionLimit(btn.dataset.limit);
                    });
                });
                
                document.getElementById('subjectSelect').addEventListener('change', () => {
                    this.updateAvailableCount();
                });
                
                document.getElementById('difficultySelect').addEventListener('change', () => {
                    this.updateAvailableCount();
                });
                
                document.getElementById('startQuizBtn').addEventListener('click', () => {
                    this.startQuiz();
                });
                
                // Study interface
                document.getElementById('backBtn').addEventListener('click', () => {
                    this.goBackToModes();
                });
                
                document.getElementById('submitBtn').addEventListener('click', () => {
                    this.submitAnswer();
                });
                
                document.getElementById('nextBtn').addEventListener('click', () => {
                    this.nextQuestion();
                });
                
                document.getElementById('hintBtn').addEventListener('click', () => {
                    this.showHint();
                });
                
                // Modals
                document.getElementById('closeHintBtn').addEventListener('click', () => {
                    this.hideHint();
                });
                
                document.getElementById('closeResultsBtn').addEventListener('click', () => {
                    this.hideResults();
                });
                
                document.getElementById('retakeBtn').addEventListener('click', () => {
                    this.retakeQuiz();
                });
                
                document.getElementById('reviewIncorrectBtn').addEventListener('click', () => {
                    this.reviewIncorrect();
                });
                
                // Stats button
                document.getElementById('statsBtn').addEventListener('click', () => {
                    this.showStats();
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    this.handleKeyboard(e);
                });
            }
            
            selectMode(mode) {
                this.currentMode = mode;
                
                if (mode === 'review') {
                    const reviewQuestions = this.getReviewQuestions();
                    if (reviewQuestions.length === 0) {
                        this.showToast('No questions to review! Complete a quiz first.', 'warning');
                        return;
                    }
                }
                
                this.showConfigModal();
            }
            
            showConfigModal() {
                document.getElementById('configModal').style.display = 'flex';
                this.updateAvailableCount();
                
                // Set defaults based on mode
                if (this.currentMode === 'board-exam') {
                    document.getElementById('subjectSelect').value = 'all';
                    this.selectQuestionLimit('100');
                } else if (this.currentMode === 'review') {
                    this.selectQuestionLimit('all');
                }
            }
            
            hideConfigModal() {
                document.getElementById('configModal').style.display = 'none';
            }
            
            selectQuestionLimit(limit) {
                document.querySelectorAll('.limit-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-limit="${limit}"]`).classList.add('active');
                this.updateAvailableCount();
            }
            
            updateAvailableCount() {
                const subject = document.getElementById('subjectSelect').value;
                const difficulty = document.getElementById('difficultySelect').value;
                const limit = document.querySelector('.limit-btn.active').dataset.limit;
                
                let availableQuestions = this.questions;
                
                if (this.currentMode === 'review') {
                    availableQuestions = this.getReviewQuestions();
                }
                
                if (subject !== 'all') {
                    availableQuestions = availableQuestions.filter(q => q.subject === subject);
                }
                
                if (difficulty !== 'all') {
                    availableQuestions = availableQuestions.filter(q => q.difficulty === difficulty);
                }
                
                const count = availableQuestions.length;
                const requestedCount = limit === 'all' ? count : parseInt(limit);
                const finalCount = Math.min(count, requestedCount);
                
                document.getElementById('availableCount').textContent = 
                    `Available questions: ${count} (will use ${finalCount})`;
                
                // Enable/disable start button
                const startBtn = document.getElementById('startQuizBtn');
                if (finalCount === 0) {
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> No Questions Available';
                } else {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Start Quiz';
                }
            }
            
            startQuiz() {
                const config = this.getQuizConfig();
                this.selectedQuestions = this.selectQuestionsForQuiz(config);
                
                if (this.selectedQuestions.length === 0) {
                    this.showToast('No questions available for this configuration!', 'error');
                    return;
                }
                
                // Shuffle questions
                this.selectedQuestions = this.shuffleArray(this.selectedQuestions);
                
                this.studySession = {
                    correct: 0,
                    incorrect: 0,
                    startTime: Date.now(),
                    answers: [],
                    config: config
                };
                
                this.currentQuestionIndex = 0;
                this.hideConfigModal();
                this.showStudyInterface();
                
                // Setup timer for timed modes
                if (this.currentMode === 'timed' || this.currentMode === 'board-exam') {
                    this.setupTimer();
                }
                
                this.loadCurrentQuestion();
            }
            
            getQuizConfig() {
                const subject = document.getElementById('subjectSelect').value;
                const difficulty = document.getElementById('difficultySelect').value;
                const limit = document.querySelector('.limit-btn.active').dataset.limit;
                
                return {
                    subject,
                    difficulty,
                    limit,
                    mode: this.currentMode
                };
            }
            
            selectQuestionsForQuiz(config) {
                let questions = [...this.questions];
                
                if (config.mode === 'review') {
                    questions = this.getReviewQuestions();
                }
                
                if (config.subject !== 'all') {
                    questions = questions.filter(q => q.subject === config.subject);
                }
                
                if (config.difficulty !== 'all') {
                    questions = questions.filter(q => q.difficulty === config.difficulty);
                }
                
                const requestedCount = config.limit === 'all' ? questions.length : parseInt(config.limit);
                return questions.slice(0, Math.min(questions.length, requestedCount));
            }
            
            showStudyInterface() {
                document.getElementById('modeSelection').style.display = 'none';
                document.getElementById('studyInterface').style.display = 'block';
            }
            
            setupTimer() {
                document.getElementById('timerSection').style.display = 'flex';
                
                if (this.currentMode === 'board-exam') {
                    // Calculate time per question based on total exam time
                    const totalMinutes = this.selectedQuestions.length <= 30 ? 240 : 300; // 4 or 5 hours
                    this.questionTimeLimit = Math.floor((totalMinutes * 60) / this.selectedQuestions.length);
                } else {
                    this.questionTimeLimit = 30; // 30 seconds for timed mode
                }
                
                this.startQuestionTimer();
            }
            
            startQuestionTimer() {
                this.timeLeft = this.questionTimeLimit;
                this.updateTimerDisplay();
                
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimerDisplay();
                    
                    if (this.timeLeft <= 0) {
                        this.handleTimeUp();
                    }
                }, 1000);
            }
            
            updateTimerDisplay() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const timerSection = document.getElementById('timerSection');
                if (this.timeLeft <= 10) {
                    timerSection.style.background = 'var(--danger-color)';
                } else if (this.timeLeft <= 20) {
                    timerSection.style.background = 'var(--warning-color)';
                } else {
                    timerSection.style.background = 'var(--warning-color)';
                }
            }
            
            handleTimeUp() {
                if (this.timer) {
                    clearInterval(this.timer);
                }
                
                if (!this.isAnswered) {
                    this.showToast('Time\'s up!', 'warning');
                    // Auto-submit with no answer (counts as incorrect)
                    this.submitAnswer(true);
                }
            }
            
            loadCurrentQuestion() {
                if (this.currentQuestionIndex >= this.selectedQuestions.length) {
                    this.endQuiz();
                    return;
                }
                
                const question = this.selectedQuestions[this.currentQuestionIndex];
                const questionNumber = this.currentQuestionIndex + 1;
                const totalQuestions = this.selectedQuestions.length;
                
                // Reset state
                this.selectedAnswer = null;
                this.isAnswered = false;
                
                // Update UI
                document.getElementById('questionCounter').textContent = 
                    `${questionNumber} of ${totalQuestions}`;
                document.getElementById('questionNumber').textContent = `#${questionNumber}`;
                document.getElementById('questionDifficulty').textContent = question.difficulty;
                document.getElementById('questionText').textContent = question.question;
                
                // Load options
                this.loadQuestionOptions(question);
                
                // Update progress
                const progress = (questionNumber / totalQuestions) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // Reset buttons
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').style.display = 'block';
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('explanationSection').style.display = 'none';
                
                // Reset timer
                if (this.currentMode === 'timed' || this.currentMode === 'board-exam') {
                    if (this.timer) {
                        clearInterval(this.timer);
                    }
                    this.startQuestionTimer();
                }
            }
            
            loadQuestionOptions(question) {
                const container = document.getElementById('optionsContainer');
                container.innerHTML = '';
                
                Object.entries(question.options).forEach(([letter, text]) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option-btn';
                    optionBtn.dataset.option = letter;
                    optionBtn.innerHTML = `
                        <span class="option-letter">${letter}.</span>
                        <span>${text}</span>
                    `;
                    
                    optionBtn.addEventListener('click', () => {
                        this.selectOption(letter);
                    });
                    
                    container.appendChild(optionBtn);
                });
            }
            
            selectOption(letter) {
                if (this.isAnswered) return;
                
                // Remove previous selection
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Select new option
                document.querySelector(`[data-option="${letter}"]`).classList.add('selected');
                this.selectedAnswer = letter;
                
                // Enable submit button
                document.getElementById('submitBtn').disabled = false;
            }
            
            submitAnswer(timeUp = false) {
                if (this.isAnswered) return;
                
                if (this.timer) {
                    clearInterval(this.timer);
                }
                
                const question = this.selectedQuestions[this.currentQuestionIndex];
                const isCorrect = this.selectedAnswer === question.correctAnswer;
                
                // Record answer
                this.studySession.answers.push({
                    questionId: question.id,
                    selectedAnswer: this.selectedAnswer,
                    correctAnswer: question.correctAnswer,
                    isCorrect: isCorrect,
                    timeUp: timeUp
                });
                
                if (isCorrect) {
                    this.studySession.correct++;
                } else {
                    this.studySession.incorrect++;
                }
                
                this.isAnswered = true;
                
                // Show correct/incorrect styling
                document.querySelectorAll('.option-btn').forEach(btn => {
                    const letter = btn.dataset.option;
                    if (letter === question.correctAnswer) {
                        btn.classList.add('correct');
                    } else if (letter === this.selectedAnswer && letter !== question.correctAnswer) {
                        btn.classList.add('incorrect');
                    }
                    btn.style.pointerEvents = 'none';
                });
                
                // Show explanation
                if (question.explanation) {
                    document.getElementById('explanationText').textContent = question.explanation;
                    document.getElementById('explanationSection').style.display = 'block';
                }
                
                // Update buttons
                document.getElementById('submitBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'block';
                
                // Show feedback toast
                if (timeUp) {
                    this.showToast('Time\'s up! Moving to next question...', 'warning');
                } else if (isCorrect) {
                    this.showToast('Correct!', 'success');
                } else {
                    this.showToast('Incorrect!', 'error');
                }
                
                // Auto-advance after delay
                setTimeout(() => {
                    if (this.currentQuestionIndex < this.selectedQuestions.length - 1) {
                        this.nextQuestion();
                    } else {
                        this.endQuiz();
                    }
                }, 2000);
            }
            
            nextQuestion() {
                this.currentQuestionIndex++;
                
                // Reset option buttons
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.classList.remove('selected', 'correct', 'incorrect');
                });
                
                this.loadCurrentQuestion();
            }
            
            endQuiz() {
                if (this.timer) {
                    clearInterval(this.timer);
                }
                
                const totalQuestions = this.selectedQuestions.length;
                const score = Math.round((this.studySession.correct / totalQuestions) * 100);
                const timeTaken = Math.round((Date.now() - this.studySession.startTime) / 60000); // minutes
                
                // Save session stats
                this.saveSessionStats();
                
                // Show results
                this.showResults(score, timeTaken);
            }
            
            showResults(score, timeTaken) {
                document.getElementById('scoreDisplay').textContent = `${score}%`;
                document.getElementById('correctCount').textContent = this.studySession.correct;
                document.getElementById('incorrectCount').textContent = this.studySession.incorrect;
                document.getElementById('timeTaken').textContent = `${timeTaken}m`;
                document.getElementById('accuracyRate').textContent = `${score}%`;
                
                document.getElementById('resultsModal').style.display = 'flex';
            }
            
            hideResults() {
                document.getElementById('resultsModal').style.display = 'none';
                this.goBackToModes();
            }
            
            retakeQuiz() {
                this.hideResults();
                this.showConfigModal();
            }
            
            reviewIncorrect() {
                const incorrectAnswers = this.studySession.answers.filter(a => !a.isCorrect);
                if (incorrectAnswers.length === 0) {
                    this.showToast('No incorrect answers to review!', 'info');
                    return;
                }
                
                // Set up review session with incorrect questions
                this.selectedQuestions = incorrectAnswers.map(answer => 
                    this.questions.find(q => q.id === answer.questionId)
                ).filter(q => q); // Remove any undefined questions
                
                this.hideResults();
                this.currentQuestionIndex = 0;
                this.studySession.startTime = Date.now();
                this.loadCurrentQuestion();
            }
            
            goBackToModes() {
                if (this.timer) {
                    clearInterval(this.timer);
                }
                
                document.getElementById('studyInterface').style.display = 'none';
                document.getElementById('modeSelection').style.display = 'block';
                document.getElementById('timerSection').style.display = 'none';
            }
            
            showHint() {
                const question = this.selectedQuestions[this.currentQuestionIndex];
                const hintText = question.hint || 'No hint available for this question.';
                
                document.getElementById('hintText').textContent = hintText;
                document.getElementById('hintModal').style.display = 'flex';
            }
            
            hideHint() {
                document.getElementById('hintModal').style.display = 'none';
            }
            
            showStats() {
                const stats = QuestionAPIService.getStats();
                const totalQuestions = this.questions.length;
                const totalSessions = stats.sessions || 0;
                const totalCorrect = stats.totalCorrect || 0;
                const totalIncorrect = stats.totalIncorrect || 0;
                const totalAnswered = totalCorrect + totalIncorrect;
                const avgAccuracy = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
                
                this.showToast(`
                    Stats:<br>
                    - Questions: ${totalQuestions}<br>
                    - Sessions: ${totalSessions}<br>
                    - Accuracy: ${avgAccuracy}%<br>
                    - Correct: ${totalCorrect}<br>
                    - Incorrect: ${totalIncorrect}
                `, 'info');
            }
            
            handleKeyboard(e) {
                if (document.getElementById('studyInterface').style.display === 'block' && !this.isAnswered) {
                    if (['1', '2', '3', '4'].includes(e.key)) {
                        const letters = ['A', 'B', 'C', 'D'];
                        const letter = letters[parseInt(e.key) - 1];
                        this.selectOption(letter);
                    } else if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        if (!document.getElementById('submitBtn').disabled) {
                            this.submitAnswer();
                        }
                    } else if (e.key === 'h' || e.key === 'H') {
                        this.showHint();
                    }
                }
                
                // Close modals with Escape
                if (e.key === 'Escape') {
                    this.hideHint();
                    document.getElementById('resultsModal').style.display = 'none';
                }
            }
            
            shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            
            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                
                toast.innerHTML = `
                    <i class="fas fa-${icons[type]}"></i>
                    <span>${message}</span>
                `;
                
                const container = document.getElementById('toastContainer');
                container.appendChild(toast);
                
                // Trigger animation
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);
                
                // Remove after delay
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
            
            saveSessionStats() {
                try {
                    const stats = QuestionAPIService.getStats();
                    
                    stats.sessions = (stats.sessions || 0) + 1;
                    stats.totalQuestions = (stats.totalQuestions || 0) + this.selectedQuestions.length;
                    stats.totalCorrect = (stats.totalCorrect || 0) + this.studySession.correct;
                    stats.totalIncorrect = (stats.totalIncorrect || 0) + this.studySession.incorrect;
                    
                    // Calculate total study time
                    const sessionTime = Math.round((Date.now() - this.studySession.startTime) / 1000); // seconds
                    stats.totalStudyTime = (stats.totalStudyTime || 0) + sessionTime;
                    
                    // Save incorrect questions for review
                    const incorrectQuestions = this.studySession.answers
                        .filter(answer => !answer.isCorrect)
                        .map(answer => this.questions.find(q => q.id === answer.questionId))
                        .filter(q => q);
                    
                    stats.reviewQuestions = incorrectQuestions;
                    
                    QuestionAPIService.updateStats(stats);
                } catch (e) {
                    console.warn('Could not save session stats:', e);
                }
            }
            
            getReviewQuestions() {
                try {
                    const stats = QuestionAPIService.getStats();
                    return stats.reviewQuestions || [];
                } catch (e) {
                    console.warn('Could not load review questions:', e);
                    return [];
                }
            }
            
            loadSavedData() {
                try {
                    this.uploadedQuestions = QuestionAPIService.getQuestions();
                } catch (e) {
                    console.warn('Could not load saved questions:', e);
                }
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            window.studyApp = new StudyApp();
        });

        // PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service_worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install notification
            if (window.studyApp) {
                window.studyApp.showToast('Install this app for offline access!', 'info');
            }
        });
    </script>
</body>
</html>
